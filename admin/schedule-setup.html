<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š - MelodyLab</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../css/admin-styles.css">
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div class="teacher-info">
                <div class="teacher-avatar" id="teacher-avatar">éˆ´</div>
                <div class="teacher-details">
                    <h2>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š</h2>
                    <p id="teacher-name">éˆ´æœ¨å…ˆç”Ÿ</p>
                </div>
            </div>
            
            <div class="dashboard-actions">
                <button class="btn btn-primary" onclick="saveSchedule()">
                    ğŸ’¾ ä¿å­˜
                </button>
                <button class="btn btn-outline" onclick="location.href='teacher-dashboard.html'">
                    â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹
                </button>
            </div>
        </div>
        
        <div class="schedule-setup">
            <h3>ğŸ“… åŸºæœ¬ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š</h3>
            <p>ãƒ¬ãƒƒã‚¹ãƒ³ã‚’æä¾›ã™ã‚‹æ›œæ—¥ã¨æ™‚é–“å¸¯ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
            
            <div id="schedule-grid">
                <!-- æ›œæ—¥åˆ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š -->
            </div>
            
            <div class="form-group" style="margin-top: 30px;">
                <label>ãƒ¬ãƒƒã‚¹ãƒ³æ™‚é–“è¨­å®š</label>
                <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                    <div>
                        <label for="lesson-duration">ãƒ¬ãƒƒã‚¹ãƒ³æ™‚é–“</label>
                        <select id="lesson-duration">
                            <option value="30">30åˆ†</option>
                            <option value="50" selected>50åˆ†</option>
                            <option value="60">60åˆ†</option>
                            <option value="90">90åˆ†</option>
                        </select>
                    </div>
                    <div>
                        <label for="break-time">ä¼‘æ†©æ™‚é–“</label>
                        <select id="break-time">
                            <option value="5">5åˆ†</option>
                            <option value="10" selected>10åˆ†</option>
                            <option value="15">15åˆ†</option>
                            <option value="20">20åˆ†</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="zoom-meeting-id">Zoomå€‹äººãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°IDï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                <input type="text" id="zoom-meeting-id" placeholder="123-456-789">
                <small>è¨­å®šã™ã‚‹ã¨ã€ã™ã¹ã¦ã®ãƒ¬ãƒƒã‚¹ãƒ³ã§åŒã˜Zoomãƒªãƒ³ã‚¯ãŒä½¿ç”¨ã•ã‚Œã¾ã™</small>
            </div>
        </div>
        
        <div class="schedule-setup" style="margin-top: 20px;">
            <h3>ğŸš« ä¾‹å¤–æ—¥è¨­å®š</h3>
            <p>ä¼‘è¬›æ—¥ã‚„ç‰¹åˆ¥ãªæ—¥ç¨‹ã‚’è¨­å®šã§ãã¾ã™ã€‚</p>
            
            <div style="display: flex; gap: 10px; align-items: end; margin-bottom: 20px; flex-wrap: wrap;">
                <div class="form-group" style="margin: 0; flex: 1; min-width: 150px;">
                    <label for="exception-date">æ—¥ä»˜</label>
                    <input type="date" id="exception-date">
                </div>
                <div class="form-group" style="margin: 0; flex: 1; min-width: 150px;">
                    <label for="exception-reason">ç†ç”±</label>
                    <input type="text" id="exception-reason" placeholder="ä¼‘è¬›ã€ä¼šè­°ãªã©">
                </div>
                <button class="btn btn-outline" onclick="addException()">è¿½åŠ </button>
            </div>
            
            <div id="exception-list"></div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/data-structures.js"></script>
    <script>
        let currentTeacher = null;
        let scheduleData = { weekly: {}, exceptions: [] };
        
        document.addEventListener('DOMContentLoaded', async function() {
            const teacherId = localStorage.getItem('currentTeacher');
            if (!teacherId) {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                location.href = 'teacher-login.html';
                return;
            }
            
            currentTeacher = teacherId;
            
            if (typeof initializeFirebase !== 'undefined') {
                initializeFirebase();
            }
            
            loadTeacherInfo();
            createScheduleGrid();
            await loadExistingSchedule();
        });
        
        function loadTeacherInfo() {
            const teacher = DefaultData.teachers.find(t => t.id === currentTeacher);
            if (teacher) {
                document.getElementById('teacher-name').textContent = teacher.name;
                document.getElementById('teacher-avatar').textContent = teacher.avatar;
                
                if (teacher.zoomPersonalMeetingId) {
                    document.getElementById('zoom-meeting-id').value = teacher.zoomPersonalMeetingId;
                }
            }
        }
        
        function createScheduleGrid() {
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const grid = document.getElementById('schedule-grid');
            
            days.forEach((day, index) => {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'time-slot-grid';
                dayDiv.innerHTML = `
                    <div class="day-label">${day}æ›œæ—¥</div>
                    <input type="time" class="time-input" id="start-${index}" value="09:00">
                    <input type="time" class="time-input" id="end-${index}" value="17:00">
                    <button class="toggle-btn" id="toggle-${index}" onclick="toggleDay(${index})">OFF</button>
                `;
                grid.appendChild(dayDiv);
                
                if (currentTeacher === 'suzuki' && index === 6) {
                    toggleDay(index);
                }
            });
        }
        
        function toggleDay(dayIndex) {
            const toggleBtn = document.getElementById(`toggle-${dayIndex}`);
            const startInput = document.getElementById(`start-${dayIndex}`);
            const endInput = document.getElementById(`end-${dayIndex}`);
            
            const isActive = toggleBtn.classList.contains('active');
            
            if (isActive) {
                toggleBtn.classList.remove('active');
                toggleBtn.textContent = 'OFF';
                startInput.disabled = true;
                endInput.disabled = true;
                delete scheduleData.weekly[dayIndex];
            } else {
                toggleBtn.classList.add('active');
                toggleBtn.textContent = 'ON';
                startInput.disabled = false;
                endInput.disabled = false;
                
                scheduleData.weekly[dayIndex] = {
                    startTime: startInput.value,
                    endTime: endInput.value,
                    isActive: true
                };
            }
            
            updateTimeInputs(dayIndex);
        }
        
        function updateTimeInputs(dayIndex) {
            const startInput = document.getElementById(`start-${dayIndex}`);
            const endInput = document.getElementById(`end-${dayIndex}`);
            
            if (scheduleData.weekly[dayIndex]) {
                scheduleData.weekly[dayIndex].startTime = startInput.value;
                scheduleData.weekly[dayIndex].endTime = endInput.value;
            }
            
            startInput.addEventListener('change', () => {
                if (scheduleData.weekly[dayIndex]) {
                    scheduleData.weekly[dayIndex].startTime = startInput.value;
                }
            });
            
            endInput.addEventListener('change', () => {
                if (scheduleData.weekly[dayIndex]) {
                    scheduleData.weekly[dayIndex].endTime = endInput.value;
                }
            });
        }
        
        async function loadExistingSchedule() {
            try {
                if (typeof FirebaseDB !== 'undefined') {
                    const schedules = await FirebaseDB.getTeacherSchedule(currentTeacher);
                    
                    schedules.forEach(schedule => {
                        if (schedule.type === 'recurring' && schedule.recurring) {
                            const dayIndex = schedule.recurring.dayOfWeek;
                            const startInput = document.getElementById(`start-${dayIndex}`);
                            const endInput = document.getElementById(`end-${dayIndex}`);
                            
                            if (startInput && endInput) {
                                startInput.value = schedule.recurring.startTime;
                                endInput.value = schedule.recurring.endTime;
                                
                                if (schedule.recurring.isActive) {
                                    toggleDay(dayIndex);
                                }
                            }
                        } else if (schedule.type === 'exception' && schedule.exception) {
                            scheduleData.exceptions.push(schedule.exception);
                        }
                    });
                    
                    renderExceptions();
                }
            } catch (error) {
                console.error('æ—¢å­˜ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        function addException() {
            const dateInput = document.getElementById('exception-date');
            const reasonInput = document.getElementById('exception-reason');
            
            if (!dateInput.value) {
                alert('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const exception = {
                date: dateInput.value,
                reason: reasonInput.value || 'ä¼‘è¬›',
                isUnavailable: true
            };
            
            scheduleData.exceptions.push(exception);
            renderExceptions();
            
            dateInput.value = '';
            reasonInput.value = '';
        }
        
        function renderExceptions() {
            const listEl = document.getElementById('exception-list');
            
            if (scheduleData.exceptions.length === 0) {
                listEl.innerHTML = '<p>ä¾‹å¤–æ—¥ã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                return;
            }
            
            const html = scheduleData.exceptions.map((exception, index) => `
                <div class="booking-item">
                    <div class="booking-info">
                        <div class="booking-time">${exception.date}</div>
                        <div class="booking-student">${exception.reason}</div>
                    </div>
                    <button class="btn btn-outline" onclick="removeException(${index})" style="padding: 4px 8px; font-size: 12px;">å‰Šé™¤</button>
                </div>
            `).join('');
            
            listEl.innerHTML = html;
        }
        
        function removeException(index) {
            if (confirm('ã“ã®ä¾‹å¤–æ—¥ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                scheduleData.exceptions.splice(index, 1);
                renderExceptions();
            }
        }
        
        async function saveSchedule() {
            try {
                const duration = parseInt(document.getElementById('lesson-duration').value);
                const breakTime = parseInt(document.getElementById('break-time').value);
                const zoomId = document.getElementById('zoom-meeting-id').value;
                
                const savePromises = [];
                
                // åŸºæœ¬ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä¿å­˜
                for (const [dayIndex, daySchedule] of Object.entries(scheduleData.weekly)) {
                    const scheduleRecord = {
                        teacherId: currentTeacher,
                        type: 'recurring',
                        recurring: {
                            dayOfWeek: parseInt(dayIndex),
                            startTime: daySchedule.startTime,
                            endTime: daySchedule.endTime,
                            duration: duration,
                            breakTime: breakTime,
                            isActive: daySchedule.isActive
                        }
                    };
                    
                    if (typeof FirebaseDB !== 'undefined') {
                        savePromises.push(FirebaseDB.saveTeacherSchedule(currentTeacher, scheduleRecord));
                    }
                }
                
                // ä¾‹å¤–æ—¥ã®ä¿å­˜
                scheduleData.exceptions.forEach(exception => {
                    const exceptionRecord = {
                        teacherId: currentTeacher,
                        type: 'exception',
                        exception: exception
                    };
                    
                    if (typeof FirebaseDB !== 'undefined') {
                        savePromises.push(FirebaseDB.saveTeacherSchedule(currentTeacher, exceptionRecord));
                    }
                });
                
                if (savePromises.length > 0) {
                    await Promise.all(savePromises);
                    alert('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                } else {
                    // Firebaseæœªè¨­å®šæ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                    localStorage.setItem(`schedule_${currentTeacher}`, JSON.stringify({
                        weekly: scheduleData.weekly,
                        exceptions: scheduleData.exceptions,
                        settings: { duration, breakTime, zoomId }
                    }));
                    alert('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰');
                }
                
            } catch (error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        
        // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        document.getElementById('lesson-duration').addEventListener('change', updateScheduleSettings);
        document.getElementById('break-time').addEventListener('change', updateScheduleSettings);
        
        function updateScheduleSettings() {
            // è¨­å®šå¤‰æ›´æ™‚ã®å‡¦ç†ï¼ˆå¿…è¦ã«å¿œã˜ã¦å®Ÿè£…ï¼‰
        }
    </script>
</body>
</html>