<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¬›å¸«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - MelodyLab</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../css/admin-styles.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† -->
        <div class="dashboard-header">
            <div class="teacher-info">
                <div class="teacher-avatar" id="teacher-avatar">éˆ´</div>
                <div class="teacher-details">
                    <h2 id="teacher-name">éˆ´æœ¨å…ˆç”Ÿ</h2>
                    <p id="teacher-instruments">ã‚®ã‚¿ãƒ¼è¬›å¸«</p>
                </div>
            </div>
            
            <div class="dashboard-actions">
                <button class="btn btn-outline" onclick="location.href='schedule-setup.html'">
                    ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š
                </button>
                <button class="btn btn-outline" onclick="location.href='../index.html'">
                    ğŸ‘¥ ç”Ÿå¾’ç”»é¢ã‚’ç¢ºèª
                </button>
                <button class="btn btn-secondary" onclick="logout()">
                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </button>
            </div>
        </div>
        
        <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ¦‚è¦ã‚«ãƒ¼ãƒ‰ -->
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3>
                    <span class="card-icon schedule">ğŸ“…</span>
                    ä»Šæ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
                </h3>
                <div id="today-schedule">
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
            
            <div class="dashboard-card">
                <h3>
                    <span class="card-icon bookings">ğŸ“</span>
                    ä»Šæ—¥ã®äºˆç´„
                </h3>
                <div id="today-bookings">
                    <p>èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
            
            <div class="dashboard-card">
                <h3>
                    <span class="card-icon stats">ğŸ“Š</span>
                    çµ±è¨ˆæƒ…å ±
                </h3>
                <div id="stats-info">
                    <p>ä»Šé€±ã®äºˆç´„: <span id="weekly-bookings">0</span>ä»¶</p>
                    <p>ä»Šæœˆã®äºˆç´„: <span id="monthly-bookings">0</span>ä»¶</p>
                </div>
            </div>
        </div>
        
        <!-- ä»Šé€±ã®äºˆç´„ä¸€è¦§ -->
        <div class="booking-list">
            <h3>ğŸ“‹ ä»Šé€±ã®äºˆç´„ä¸€è¦§</h3>
            <div id="weekly-booking-list">
                <p>èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    
    <script src="../js/firebase-config.js"></script>
    <script src="../js/data-structures.js"></script>
    <script>
        let currentTeacher = null;
        let bookingsListener = null;
        
        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // èªè¨¼ãƒã‚§ãƒƒã‚¯
            const teacherId = localStorage.getItem('currentTeacher');
            if (!teacherId) {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                location.href = 'teacher-login.html';
                return;
            }
            
            // FirebaseåˆæœŸåŒ–
            if (typeof initializeFirebase !== 'undefined') {
                initializeFirebase();
            }
            
            // è¬›å¸«æƒ…å ±ã‚’è¨­å®š
            currentTeacher = teacherId;
            await loadTeacherInfo();
            await loadDashboardData();
            
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®è¨­å®š
            setupRealTimeUpdates();
        });
        
        // è¬›å¸«æƒ…å ±ã®èª­ã¿è¾¼ã¿
        async function loadTeacherInfo() {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¬›å¸«æƒ…å ±ã‚’å–å¾—
            const teacher = DefaultData.teachers.find(t => t.id === currentTeacher);
            if (teacher) {
                document.getElementById('teacher-name').textContent = teacher.name;
                document.getElementById('teacher-avatar').textContent = teacher.avatar;
                document.getElementById('teacher-instruments').textContent = 
                    teacher.instruments.map(i => DataUtils.getInstrumentName(i)).join('ã€') + 'è¬›å¸«';
            }
        }
        
        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        async function loadDashboardData() {
            try {
                // ä»Šæ—¥ã®æ—¥ä»˜
                const today = new Date().toISOString().split('T')[0];
                
                // ä»Šæ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤ºï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰
                updateTodaySchedule();
                
                // ä»Šæ—¥ã®äºˆç´„ã‚’å–å¾—
                if (typeof FirebaseDB !== 'undefined') {
                    const bookings = await FirebaseDB.getBookings(currentTeacher);
                    updateTodayBookings(bookings.filter(b => b.date === today));
                    updateWeeklyBookings(bookings);
                    updateStats(bookings);
                } else {
                    // Firebaseæœªè¨­å®šæ™‚ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
                    showSampleData();
                }
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showSampleData();
            }
        }
        
        // ä»Šæ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤º
        function updateTodaySchedule() {
            const today = new Date().getDay(); // 0=æ—¥æ›œæ—¥
            const scheduleEl = document.getElementById('today-schedule');
            
            // ã‚µãƒ³ãƒ—ãƒ«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆåœŸæ›œæ—¥ã®å ´åˆï¼‰
            if (today === 6) {
                scheduleEl.innerHTML = `
                    <p>âœ… 9:00-17:00 ãƒ¬ãƒƒã‚¹ãƒ³å¯¾å¿œæ™‚é–“</p>
                    <p>â° 50åˆ†ãƒ¬ãƒƒã‚¹ãƒ³ + 10åˆ†ä¼‘æ†©</p>
                `;
            } else {
                scheduleEl.innerHTML = '<p>æœ¬æ—¥ã¯ä¼‘è¬›æ—¥ã§ã™</p>';
            }
        }
        
        // ä»Šæ—¥ã®äºˆç´„è¡¨ç¤º
        function updateTodayBookings(todayBookings) {
            const bookingsEl = document.getElementById('today-bookings');
            
            if (todayBookings.length === 0) {
                bookingsEl.innerHTML = '<p>æœ¬æ—¥ã®äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            const html = todayBookings.map(booking => `
                <div class="booking-item">
                    <div class="booking-info">
                        <div class="booking-time">${booking.startTime} - ${booking.endTime}</div>
                        <div class="booking-student">${booking.studentId}ã•ã‚“ (${DataUtils.getInstrumentName(booking.instrument)})</div>
                    </div>
                    <span class="booking-status status-${booking.status}">${booking.status === 'confirmed' ? 'ç¢ºå®š' : 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'}</span>
                </div>
            `).join('');
            
            bookingsEl.innerHTML = html;
        }
        
        // ä»Šé€±ã®äºˆç´„ä¸€è¦§è¡¨ç¤º
        function updateWeeklyBookings(allBookings) {
            const listEl = document.getElementById('weekly-booking-list');
            
            // ä»Šé€±ã®äºˆç´„ã‚’ãƒ•ã‚£ãƒ«ã‚¿
            const thisWeek = getThisWeekBookings(allBookings);
            
            if (thisWeek.length === 0) {
                listEl.innerHTML = '<p>ä»Šé€±ã®äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            const html = thisWeek.map(booking => `
                <div class="booking-item">
                    <div class="booking-info">
                        <div class="booking-time">${booking.date} ${booking.startTime} - ${booking.endTime}</div>
                        <div class="booking-student">${booking.studentId}ã•ã‚“ (${DataUtils.getInstrumentName(booking.instrument)})</div>
                    </div>
                    <span class="booking-status status-${booking.status}">${booking.status === 'confirmed' ? 'ç¢ºå®š' : 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'}</span>
                </div>
            `).join('');
            
            listEl.innerHTML = html;
        }
        
        // çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
        function updateStats(allBookings) {
            const thisWeek = getThisWeekBookings(allBookings);
            const thisMonth = getThisMonthBookings(allBookings);
            
            document.getElementById('weekly-bookings').textContent = thisWeek.length;
            document.getElementById('monthly-bookings').textContent = thisMonth.length;
        }
        
        // ä»Šé€±ã®äºˆç´„ã‚’å–å¾—
        function getThisWeekBookings(bookings) {
            const today = new Date();
            const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
            const endOfWeek = new Date(today.setDate(startOfWeek.getDate() + 6));
            
            return bookings.filter(booking => {
                const bookingDate = new Date(booking.date);
                return bookingDate >= startOfWeek && bookingDate <= endOfWeek;
            });
        }
        
        // ä»Šæœˆã®äºˆç´„ã‚’å–å¾—
        function getThisMonthBookings(bookings) {
            const thisMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            return bookings.filter(booking => booking.date.startsWith(thisMonth));
        }
        
        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºï¼ˆFirebaseæœªè¨­å®šæ™‚ï¼‰
        function showSampleData() {
            document.getElementById('today-bookings').innerHTML = `
                <div class="booking-item">
                    <div class="booking-info">
                        <div class="booking-time">10:00 - 10:50</div>
                        <div class="booking-student">å±±ç”°å¤ªéƒã•ã‚“ (ã‚®ã‚¿ãƒ¼)</div>
                    </div>
                    <span class="booking-status status-confirmed">ç¢ºå®š</span>
                </div>
            `;
            
            document.getElementById('weekly-booking-list').innerHTML = `
                <div class="booking-item">
                    <div class="booking-info">
                        <div class="booking-time">2025-05-31 10:00 - 10:50</div>
                        <div class="booking-student">å±±ç”°å¤ªéƒã•ã‚“ (ã‚®ã‚¿ãƒ¼)</div>
                    </div>
                    <span class="booking-status status-confirmed">ç¢ºå®š</span>
                </div>
            `;
            
            document.getElementById('weekly-bookings').textContent = '1';
            document.getElementById('monthly-bookings').textContent = '4';
        }
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®è¨­å®š
        function setupRealTimeUpdates() {
            if (typeof FirebaseListeners !== 'undefined' && currentTeacher) {
                bookingsListener = FirebaseListeners.listenToBookingChanges(currentTeacher, (bookings) => {
                    const today = new Date().toISOString().split('T')[0];
                    updateTodayBookings(bookings.filter(b => b.date === today));
                    updateWeeklyBookings(bookings);
                    updateStats(bookings);
                });
            }
        }
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('currentTeacher');
                if (bookingsListener) {
                    bookingsListener(); // ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
                }
                location.href = 'teacher-login.html';
            }
        }
    </script>
</body>
</html>